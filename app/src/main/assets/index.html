<html>
    <body>
        <input type="button" value="Install package..." onClick="command('install')" />
        <input type="button" value="List Bluetooth devices" onClick="listBT()" />
        <div id="div_controls">Controls div.</div>
        <textarea id="ta_log" rows=20></textarea>
        <script type="text/javascript">

var div_controls = document.getElementById("div_controls");
var ta = document.getElementById("ta_log");
ta.style.width="100%";

function log(str) {
    ta.value = ta.value + str + "\n";
}

function command(cmd) {
    CommandHandler.command(cmd);
    log("C:"+cmd);
}

function response(str) {
    log("R:"+str);
    if(str[0]=='{') jsonResponse(JSON.parse(str));
}

function jsonResponse(obj) {
    if(obj.devs) {
        div_controls.innerHTML="";
        var devs=obj.devs;
        for( var i=0; i<devs.length; i++) {
            var btn = document.createElement("button");
            var t = document.createTextNode(devs[i].name + " " + devs[i].address);
            btn.appendChild(t);
            btn.addEventListener("click", function(){
                var address=this.innerText.slice(-17);
                log(">"+address+"<");
                connect(address);
            });
            div_controls.appendChild(btn);
        }
    }
}

function connect(address) {
    var cmd = {};
    cmd["cmd"]="add service";
    cmd["name"]="My Bluetooth gadget";
    cmd["type"]="rfcomm";
    cmd["address"]=address;
    cmd["bind"]="0.0.0.0";
    cmd["port"]="8085";
    var json = JSON.stringify(cmd);
    CommandHandler.command(json);
}

function listBT() {
    var cmd = {};
    cmd["cmd"]="get bluetooth devices";
    var json = JSON.stringify(cmd);
    CommandHandler.command(json);
}

CommandHandler.command('ready');

        </script>
    </body>
</html>

